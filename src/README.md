# MeshExchange Source Code (src/)

Этот каталог содержит полный исходный код системы MeshExchange — безопасной системы обмена файлами для локальных и распределенных сетей. MeshExchange сочетает в себе криптографические примитивы, сильное шифрование и опциональное хранение метаданных в MongoDB для создания гибкой платформы безопасного обмена файлами.

## Общая структура

Каталог `src/` организован модульно для обеспечения четкого разделения ответственности:

- **Основные компоненты**: демон наблюдения (`main.c`), клиент (`client/`) и сервер (`server/`)
- **Криптография**: AES-GCM шифрование и BLAKE3 хеширование
- **База данных**: интеграция с MongoDB для метаданных
- **Утилиты**: файловые операции, MIME-типы, общие функции
- **Сертификаты**: TLS/мTLS сертификаты для безопасной коммуникации

## Директории

### `client/`
Клиентская часть системы для загрузки, скачивания и просмотра файлов.

**Ключевые файлы:**
- `client.c` — основной клиент с поддержкой команд upload/download/list через mTLS
- `build.sh` — скрипт сборки клиента
- `client` — собранный бинарный файл клиента

**Особенности:**
- Поддержка прогресс-баров при передаче файлов
- Валидация целостности через BLAKE3 хеши
- mTLS аутентификация с клиентскими сертификатами

### `server/`
Серверная часть с поддержкой многопоточной обработки клиентов.

**Ключевые файлы:**
- `server.c` — основной сервер с шифрованием файлов AES-GCM
- `build_server.sh` — скрипт сборки сервера
- `server` — собранный бинарный файл сервера

**Функциональность:**
- Обработка команд upload/download/list
- Шифрование файлов на лету с AES-256-GCM
- Хранение метаданных в MongoDB
- Поддержка приватных и публичных файлов

### `core/`
Ядро системы с компонентами наблюдения за файловой системой.

**Файлы:**
- `inotify_watcher.c/.h` — обертка вокруг inotify для мониторинга изменений файлов

**Назначение:**
- Отслеживание создания, модификации и удаления файлов
- Интеграция с демоном для автоматического логирования событий

### `crypto/`
Криптографические утилиты и шифрование.

**Файлы:**
- `aes_gcm.c/.h` — реализация AES-GCM шифрования/дешифрования
- `crypto_decrypt_aes_gcm.c` — дополнительная логика дешифрования

**Особенности:**
- Использование OpenSSL EVP API для AES-256-GCM
- Генерация случайных IV для каждой операции шифрования
- Аутентифицированное шифрование с тегами целостности

### `db/`
Интеграция с MongoDB для хранения метаданных.

**Файлы:**
- `mongo_client.c/.h` — клиент MongoDB
- `mongo_ops.c/.h` — операции с базой данных
- `mongo_ops_server.c/.h` — серверные операции MongoDB
- `build.sh` — сборка компонентов базы данных

**Функциональность:**
- Хранение метаданных файлов (размер, владелец, получатель)
- Логирование событий в "proc map" для каждого файла
- Управление доступом (публичные/приватные файлы)

### `common/`
Общие утилиты, используемые по всему проекту.

**Файлы:**
- `hash_utils.c/.h` — утилиты хеширования (BLAKE3)

**Назначение:**
- Централизованные функции хеширования
- Переиспользуемые компоненты

### `net/`
Сетевые утилиты и коммуникации.

**Файлы:**
- `signal_sender.c` — отправка сигналов между процессами

**Назначение:**
- Межпроцессное взаимодействие
- Сигнализация о событиях

### `utils/`
Общие утилиты для работы с файлами и данными.

**Файлы:**
- `fs.c/.h` — файловые операции
- `mime.c/.h` — определение MIME-типов
- `utils.c` — общие вспомогательные функции

**Функциональность:**
- Работа с файловой системой
- Определение типов файлов по расширению
- Вспомогательные функции для строк и памяти

## Ключевые файлы в корне src/

### Исполняемые файлы и бинарники
- `main` — собранный демон наблюдения
- `exchange-daemon` — демон для мониторинга директории
- `mongo` — утилита для работы с MongoDB

### Исходный код
- `main.c` — демон, использующий inotify для отслеживания изменений в директории `filetrade/`
- `daemon_test.c` — тестовый файл для демона

### Сертификаты и ключи
- `ca.pem`, `ca-key.pem`, `ca.srl` — корневой сертификат удостоверяющего центра
- `server-cert.pem`, `server-key.pem`, `server.csr` — сертификаты сервера
- `client-cert.pem`, `client-key.pem`, `client.csr` — сертификаты клиента

### Другие
- `README.md` — эта документация
- `.analyzer_cache` — кэш статического анализатора (автоматически генерируется)

## Зависимости и сборка

### Системные зависимости
- **OpenSSL** — для TLS/mTLS и AES-GCM
- **MongoDB C Driver** (libmongoc) — для работы с MongoDB
- **BLAKE3** — включена в проект как `deps/blake3/`
- **POSIX-совместимый компилятор** (gcc/clang) с поддержкой C99

### Сборка
Используйте предоставленные скрипты сборки:
```bash
# Сборка клиента
./client/build.sh

# Сборка сервера
./server/build_server.sh

# Сборка всего проекта
../build.sh  # из корня проекта
```

### Инициализация
1. **MongoDB**: Запустите MongoDB и выполните `../mongo/init.js`
2. **Сертификаты**: Используйте существующие или сгенерируйте новые
3. **Директория хранения**: Убедитесь, что `../../filetrade/` существует

## Архитектура и поток данных

1. **Демон** (`main.c`) мониторит директорию с помощью inotify
2. **Клиент** подключается к серверу через mTLS
3. **Сервер** принимает файлы, шифрует их AES-GCM и сохраняет метаданные в MongoDB
4. **Хеширование** BLAKE3 обеспечивает целостность данных
5. **Доступ** контролируется через отпечатки сертификатов

## Безопасность

- **mTLS**: Взаимная аутентификация клиента и сервера
- **AES-256-GCM**: Аутентифицированное шифрование с AEAD
- **BLAKE3**: Криптографически стойкое хеширование
- **Контроль доступа**: Файлы могут быть приватными (для конкретного получателя) или публичными

## Разработка и отладка

- Логи записываются в `/tmp/exchange-daemon.log` и `/tmp/file-server.log`
- Используйте тесты из `../tests/` для проверки компонентов
- Для отладки сборки добавьте флаги `-g -O0`

## Расширение системы

Модульная архитектура позволяет легко добавлять:
- Новые криптографические алгоритмы
- Дополнительные хранилища метаданных
- Протоколы аутентификации
- Функции синхронизации

---

*Этот README предоставляет полное описание структуры исходного кода MeshExchange. Для дополнительной информации обратитесь к основному README.md в корне проекта.*
